service: qubitRawAutomation
description: Qubit Raw Automation service to fetch news from various sources and process them

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  runtime: nodejs20.x
  region: ap-south-1
  environment:
    AWS_REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}

functions:
  app:
    handler: src/app.handler
    timeout: 60
    events:
      - http: ANY /
      - http: ANY /{proxy+}
  # EventBridge scheduled scraper (Node)
  scheduledScraper:
    handler: src/handlers/scheduledScraper.handler
    timeout: 300
    memorySize: 512
    layers:
      - { Ref: PgLayerLambdaLayer }
    events:
      - schedule:
          rate: rate(6 hours)
          enabled: true
          description: Scrape news from configured sources every 6 hours
          input:
            source: eventbridge.schedule
            action: scrape
   

package:
  individually: true
  excludeDevDependencies: true

plugins:
  - serverless-esbuild
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node20
    platform: node
    keepOutputDirectory: true
    concurrency: 10
    external:
      - pg 

layers:
  pg-layer:
    path: layers/pg-layer
    name: pg-lambda-layer
    compatibleRuntimes:
      - nodejs20.x
    description: PostgreSQL driver layer
   

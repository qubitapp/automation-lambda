service: qubitRawAutomation
description: Qubit Raw Automation service to fetch news from various sources and process them

frameworkVersion: "3"

provider:
  name: aws
  stage: ${opt:stage, 'dev'}
  runtime: nodejs20.x
  region: ap-south-1
  environment:
    AWS_REGION: ${self:provider.region}
    STAGE: ${self:provider.stage}

plugins:
  - serverless-esbuild
  - serverless-dotenv-plugin
  - serverless-offline

# ------------------------------
# FUNCTIONS
# ------------------------------
functions:
  # Express / API Gateway
  app:
    handler: src/app.handler
    timeout: 60
    events:
      - http:
          path: /
          method: any
          cors: true
      - http:
          path: /{proxy+}
          method: any
          cors: true
    layers:
      - { Ref: PgLayerLambdaLayer }

  # EventBridge scheduled scraper (Node)
  scheduledScraper:
    handler: src/handlers/scheduledScraper.handler
    timeout: 300
    memorySize: 512
    layers:
      - { Ref: PgLayerLambdaLayer }
    events:
      - schedule:
          rate: rate(6 hours)
          enabled: true
          description: Scrape news from configured sources every 6 hours
          input:
            source: eventbridge.schedule
            action: scrape

# ------------------------------
# PACKAGING
# ------------------------------
package:
  individually: true
  excludeDevDependencies: true
  patterns:
    - '!news.json'
    - '!.env'
    - '!README.md'

# ------------------------------
# BUILD CONFIG
# ------------------------------
custom:
  esbuild:
    bundle: true
    minify: true
    sourcemap: true
    target: node20
    platform: node
    keepOutputDirectory: true
    concurrency: 10
    external:
      - pg

# ------------------------------
# LAYERS
# ------------------------------
layers:
  pg-layer:
    path: layers/pg-layer
    name: pg-lambda-layer
    description: PostgreSQL driver layer
    compatibleRuntimes:
      - nodejs20.x
